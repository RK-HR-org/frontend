# HH Search Playbook для Cozy/Coze

Этот документ можно использовать как основу для docx-файла, который будет загружен в Coze как текстовое знание.  
Он описывает правила маппинга текстовых запросов рекрутеров в параметры поиска HH и ожидаемый JSON от Cozy.

## 1. Введение

### 1.1. Кто пользователи

- Внутренние рекрутеры и sourcer’ы.
- Основной язык взаимодействия — русский (допускаются английские термины и названия).

### 1.2. Роль Cozy-бота

- Помогает превратить свободный текст запроса («кого ищем») в структурированные параметры поиска HH.
- Возвращает один JSON по фиксированному контракту (см. `cozy-hh-enrich-prompt.txt`).
- Не общается с пользователем напрямую в диалоговом режиме — его задача именно обогащение/разбор.

### 1.3. Общий поток

1. Рекрутер пишет положительный и отрицательный промпты (positive/negative).
2. Cozy-бот анализирует текст и использует справочники HH из Coze (xlsx-таблицы).
3. Бот возвращает JSON, который маппится в форму расширенного поиска и в запросы к HH API.

## 2. Общие принципы

1. **Никаких выдуманных значений.**
   - Нельзя придумывать возраст, зарплату, опыт, языки, график и т.п. «по здравому смыслу».
   - Если нет прямого указания в тексте — поле остаётся пустым (`null` или `[]`).

2. **Строгий контракт JSON.**
   - Структура JSON описана в `cozy-hh-enrich-prompt.txt` (ключи: `text_queries`, `keywords_include`, `skills`, `experience`, `age`, `salary`, `location`, `schedule`, `employment`, `languages` и т.п.).
   - Ответ — только один валидный JSON-объект, без пояснений и markdown.

3. **Разделение текстового поиска и структурированных полей.**
   - Всё, что можно выразить как чёткий структурированный фильтр (возраст, опыт, зарплата, география, график, занятость, языки), должно идти в соответствующие поля, а не в текстовый поиск.
   - Текстовый поиск (`text_queries` / `text_search`) — только для содержимого резюме/вакансий (должности, навыки, опыт, компании и т.п.).

4. **Использование словарей HH.**
   - Для регионов, навыков, ролей, типов занятости и графиков бот опирается на таблицы из `hh_search_reference.xlsx` (листы `hh_areas`, `hh_skills`, `hh_professional_roles`, `hh_employment`, `hh_schedule`, `hh_experience_categories` и др.).
   - Если подходящей строки нет или совпадение неоднозначно — бот не заполняет ID, а использует только текст (если это допускается контрактом).

## 3. Блок: текст и ключевые слова

### 3.1. Поля

- `text_queries[]`:
  - `text` — текст условия;
  - `logic` — `all` / `any` / `phrase` / `except`;
  - `field` — `everywhere`, `title`, `experience`, `skills`, `experience_company`, `experience_position`, `experience_description`, `education`;
  - `period` — `all_time` / `last_year` / `last_three_years` / `last_six_years`.
- `keywords_include[]`, `keywords_exclude[]` — списки ключевых слов/фраз для дополнительного использования.

### 3.2. Что класть в text_queries

- Названия профессий и должностей:
  - «python разработчик», «бухгалтер», «product manager».
- Важные ключевые фразы об опыте:
  - «менеджер проектов в IT», «опыт работы в FMCG», «работа в Big4».
- Группы навыков, если они описаны как текстовый поиск:
  - «SQL и Power BI», «Python, Django, FastAPI».

### 3.3. Что НЕ класть в text_queries

- Возрастные требования («от 25 до 40», «не старше 50») → только `age`.
- Зарплата («от 100к», «до 200к», «вилка 80-120») → только `salary`.
- География («Москва», «удалённо», «Санкт-Петербург») → `location` и/или `schedule`.
- График и занятость («полная занятость», «частичная занятость», «удалёнка») → `schedule`, `employment`.
- Пол, гражданство, готовность к переезду и командировкам → соответствующие структурированные поля (при наличии в контракте/форме).

### 3.4. Мини-примеры

**Пример 1**  
Промпт: «Python разработчик, опыт за последние 3 года в продуктовых компаниях»  
Ожидаемый JSON-фрагмент:
- `text_queries`:
  - `{"text": "Python разработчик", "logic": "all", "field": "experience", "period": "all_time"}`
  - `{"text": "продуктовых компаниях", "logic": "all", "field": "experience_company", "period": "last_three_years"}`

**Пример 2**  
Промпт: «менеджер, удалёнка, частичная занятость»  
Ожидаемый JSON-фрагмент:
- `text_queries`: только по должности «менеджер».
- `schedule`: `["remote"]`.
- `employment`: `["part"]`.

## 4. Блок: опыт (experience.hh_experience_id)

### 4.1. Поле и словарь

- JSON: `experience.hh_experience_id` (строка или null).
- Возможные значения:
  - `noExperience`
  - `between1And3`
  - `between3And6`
  - `moreThan6`
- Словарь в `hh_search_reference.xlsx`: лист `hh_experience_categories`.

### 4.2. Когда заполнять

Заполнять ТОЛЬКО при наличии явных указаний:

- Позитивные примеры:
  - «без опыта», «джун», «junior» → `noExperience`;
  - «1-3 года опыта», «от года» → `between1And3`;
  - «3+ года опыта», «от трёх лет», «опыт 3-6 лет» → `between3And6`;
  - «senior», «lead», «более 6 лет опыта» → `moreThan6`.

- Негативные примеры (не заполнять категорию):
  - «опыт в продажах», «есть релевантный опыт» (без длительности);
  - «успешный опыт управления командами» без цифр.

Если нет чёткой категориальной информации — `hh_experience_id = null`.

## 5. Блок: возраст (age)

### 5.1. Поля

- `age.age_from` — минимальный возраст или нижняя граница.
- `age.age_to` — максимальный возраст или верхняя граница.

### 5.2. Разбор фраз

Разбирать только явные числа или числа прописью.

- «не моложе 25» → `age_from = 25`.
- «не старше 50», «до 50 лет» → `age_to = 50`.
- «от 25 до 50», «25-50 лет» → `age_from = 25`, `age_to = 50`.
- «старше 30» → `age_from = 30`.
- «моложе 40» → `age_to = 40`.
- Числа прописью:
  - «пятидесяти» → 50,
  - «тридцати» → 30,
  - «двадцати пяти» → 25.

Не конвертировать:
- «молодой специалист», «зрелый кандидат», «возраст не важен», «любой возраст».

В этих случаях: `age_from = null`, `age_to = null`.

## 6. Блок: зарплата (salary)

### 6.1. Поля

- `salary.salary_from`
- `salary.salary_to`
- `salary.currency`
- `salary.only_with_salary` (если явно нужно «только с указанной зарплатой»).

### 6.2. Числа и валюты

- Всегда приводить суммы к полным значениям в выбранной валюте.
- По умолчанию валюта — `RUR`, если явно не указано иное.
- Фразы:
  - «50-70 тысяч» → `from = 50000`, `to = 70000` (тысяч → *1000);
  - «от 100к», «от 100 тыс» → `from = 100000`;
  - «до 200к» → `to = 200000`;
  - «вилка 80-120» → `from = 80000`, `to = 120000`;
  - «зп от 80» → `from = 80000`.

Не конвертировать:
- «конкурентная зарплата», «рыночная оплата», «достойная зарплата».

В этих случаях — `salary_from = null`, `salary_to = null`.

Если явно указана валюта:
- «в долларах» → `currency = "USD"`;
- «в евро» → `currency = "EUR"`;
- и т.п. (по словарю валют HH).

## 7. Блок: география (location)

### 7.1. Поля

- `location.area_id` — ID региона из HH.
- `location.area_name` — человеко-читаемое название.

### 7.2. Использование словаря hh_areas

- При упоминании города/региона:
  - привести название к нормализованному виду (с учётом сокращений: «СПб», «Питер», «СПБ» → Санкт-Петербург);
  - найти точное или почти точное совпадение по колонкам `name` / `normalized_name` / `aliases` в листе `hh_areas`;
  - если найдено однозначное совпадение:
    - `area_id = json_value` из строки,
    - `area_name = name` из строки;
  - если совпадение неоднозначно или не найдено:
    - `area_id = null`,
    - `area_name` = текст из промпта («Подмосковье», «СЗФО» и т.п.) — по необходимости.

### 7.3. Особые случаи

- «удалённо», «удалёнка», «работа из дома»:
  - НЕ ставить `area_id`, если не назван конкретный регион;
  - информация уходит в `schedule = ["remote"]`.
- Комбинации:
  - «Москва или удалёнка»:
    - `location.area_id` по Москве (если прозрачно),
    - `schedule` включает `remote`.

## 8. Блок: график и занятость (schedule, employment)

### 8.1. График (schedule)

- Значения (см. `hh_schedule` / `SCHEDULE`):
  - `fullDay`;
  - `shift`;
  - `flexible`;
  - `remote`;
  - `flyInFlyOut`.

Примеры:
- «полный день» → `["fullDay"]`.
- «сменный график» → `["shift"]`.
- «удалёнка», «удалённая работа» → `["remote"]`.
- «вахта», «вахтовый метод» → `["flyInFlyOut"]`.

### 8.2. Тип занятости (employment)

- Значения (см. `hh_employment` / `EMPLOYMENT`):
  - `full`, `part`, `project`, `volunteer`, `probation`.

Примеры:
- «полная занятость» → `["full"]`.
- «частичная занятость», «подработка» → `["part"]`.
- «проектная работа» → `["project"]`.
- «волонтёрство» → `["volunteer"]`.
- «стажировка», «стажёр» → `["probation"]`.

## 9. Блок: навыки (skills)

### 9.1. Поле

- JSON: `skills[]` — список строк (названий навыков).

### 9.2. Использование hh_skills

- Для каждого явно упомянутого навыка:
  - искать по колонкам `name` / `aliases` в листе `hh_skills`;
  - при успешном совпадении:
    - в JSON можно вернуть `name` (читаемое название),
    - при необходимости ID навыка остаётся в таблице как `json_value`.

Не добавлять:
- общие личные качества: «ответственность», «стрессоустойчивость» и т.п., если они не являются стандартными навыками HH;
- дубли должностей (например, «менеджер по продажам» как навык).

## 10. Блок: языки (languages)

### 10.1. Поле

- `languages[]` — массив объектов:
  - `id` — код языка (например, `eng`, `deu`, `ita`);
  - `level` — код уровня (`a1`, `b1`, `b2`, `c1`, `c2`) или null.

### 10.2. Примеры

- «английский B2», «английский upper-intermediate» → `{"id": "eng", "level": "b2"}` (приближение).
- «английский fluent», «свободный английский» → `{"id": "eng", "level": "c1"}` или `{"id": "eng", "level": "c2"}` (по выбранной договорённости).

Не заполнять:
- если сказано только «знание английского приветствуется», без указания хотя бы примерного уровня.

## 11. Блок: пол (gender)

### 11.1. Поле

- `gender` — `"male"` / `"female"` / `null`.

### 11.2. Правила

Заполнять только при явном или однозначно вытекающем указании:

- Примеры → `female`:
  - «женщина»;
  - «женский пол»;
  - «не мужской пол» (при явном бинарном противопоставлении).

- Примеры → `male`:
  - «мужчина»;
  - «мужской пол»;
  - «не женский пол».

Не заполнять (null):
- «пол не важен», «любой пол», «гендер не важен»;
- если пол только подразумевается из названия должности, но явно не указан.

## 12. Работа со справочниками в Coze

### 12.1. Табличные знания

- `hh_search_reference.xlsx` загружается в Coze как табличное знание.
- Важные листы: `fields_overview`, `hh_areas`, `hh_skills`, `hh_employment`, `hh_schedule`, `hh_experience_categories` и др.

### 12.2. Стратегия поиска в таблицах

1. Привести исходную фразу к нормализованному виду (нижний регистр, убрать лишние пробелы, стандартные сокращения).
2. Пытаться найти:
   - сначала точное совпадение по `name`;
   - затем по `normalized_name` или `aliases`, если такие колонки есть.
3. При единственном понятном совпадении использовать `json_value` как итоговое значение для JSON/HH API.
4. При нескольких разных совпадениях или полном отсутствии совпадений:
   - не заполнять ID-поле;
   - при необходимости использовать только человеко-читаемое значение (например, `area_name`).

## 13. Анти-примеры (чего делать нельзя)

1. **Нельзя придумывать возраст.**
   - Плохо: «молодой специалист» → `age_from = 20`, `age_to = 30`.
   - Правильно: `age_from = null`, `age_to = null`.

2. **Нельзя угадывать зарплатную вилку.**
   - Плохо: «конкурентная зарплата» → `salary_from = 80000`.
   - Правильно: `salary_from = null`, `salary_to = null`.

3. **Нельзя ставить опыт без цифр.**
   - Плохо: «с опытом в продажах» → `hh_experience_id = "between1And3"`.
   - Правильно: `hh_experience_id = null`, а в текстовом поиске и/или ключевых словах остаётся фраза про опыт.

4. **Нельзя придумывать регионы/ID.**
   - Плохо: «подмосковье» → `area_id` какого-то случайного города.
   - Правильно: если в таблице `hh_areas` нет подходящей записи, оставить `area_id = null` и, по необходимости, заполнить только `area_name = "Подмосковье"`.

5. **Нельзя превращать общие качества в навыки.**
   - Плохо: «стрессоустойчивость» как навык, если он не является стандартным навыком HH.
   - Правильно: не добавлять в `skills`.

## 14. Рекомендуемый формат примеров для тестирования

Для каждого тестового кейса:

1. Вход:
   - `prompts.positive`;
   - `prompts.negative`.
2. Ожидаемый JSON (по ключевым полям).
3. Краткое пояснение:
   - какие поля были заполнены и почему;
   - какие поля оставлены пустыми и почему.

Подробный список тест-кейсов приведён в отдельном документе `hh_search_validation_cases.md`.

